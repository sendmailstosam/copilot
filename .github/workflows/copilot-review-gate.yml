name: Copilot Review Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

jobs:
  copilot-review-gate:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Wait for Copilot review and check results
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const headSha = context.payload.pull_request.head.sha;
            const maxAttempts = 20;
            const delaySeconds = 30;

            core.info(`PR #${prNumber}, latest commit: ${headSha}`);

            let copilotReview = null;

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              core.info(`Checking for Copilot review on latest commit... (attempt ${attempt}/${maxAttempts})`);

              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });

              // Find Copilot's review for the latest commit specifically
              copilotReview = reviews.find(
                r => r.user.type === 'Bot'
                  && r.user.login.toLowerCase().includes('copilot')
                  && r.commit_id === headSha
              );

              if (copilotReview) {
                core.info(`Found Copilot review from: ${copilotReview.user.login} for commit ${headSha}`);
                break;
              }

              if (attempt < maxAttempts) {
                core.info(`Copilot hasn't reviewed commit ${headSha.substring(0, 7)} yet. Waiting ${delaySeconds}s...`);
                await new Promise(resolve => setTimeout(resolve, delaySeconds * 1000));
              }
            }

            if (!copilotReview) {
              core.setFailed('Timed out waiting for Copilot code review on the latest commit.');
              return;
            }

            // Get all review comments on this PR
            const { data: comments } = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            // Filter to Copilot's comments on the latest commit
            const copilotComments = comments.filter(
              c => c.user.type === 'Bot'
                && c.user.login.toLowerCase().includes('copilot')
                && c.commit_id === headSha
            );

            if (copilotComments.length > 0) {
              core.setFailed(
                `Copilot found ${copilotComments.length} issue(s). Please address them before merging.`
              );
              for (const c of copilotComments) {
                core.error(`${c.path}: ${c.body.substring(0, 200)}`);
              }
            } else {
              core.info('Copilot review passed with no issues!');
            }
