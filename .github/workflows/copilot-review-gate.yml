name: Copilot Review Gate

on:
  pull_request_review:
    types: [submitted]

jobs:
  copilot-review-gate:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Check Copilot review result
        uses: actions/github-script@v7
        with:
          script: |
            const review = context.payload.review;
            const prNumber = context.payload.pull_request.number;

            // Skip non-Copilot reviews with a neutral exit
            if (
              review.user.type !== 'Bot' ||
              !review.user.login.toLowerCase().includes('copilot')
            ) {
              core.info(`Review by ${review.user.login} is not from Copilot â€” skipping.`);
              return;
            }

            core.info(`Copilot review received on PR #${prNumber}.`);

            // Fetch the current PR head SHA via API (not from the event payload)
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            const headSha = pr.head.sha;

            core.info(`Current PR head SHA: ${headSha}`);
            core.info(`Copilot review commit_id: ${review.commit_id}`);

            // Fail if Copilot's review is for an outdated commit
            if (review.commit_id !== headSha) {
              core.setFailed(
                `Copilot's review is for commit ${review.commit_id.substring(0, 7)}, ` +
                `but the PR head is now ${headSha.substring(0, 7)}. ` +
                `Please re-request Copilot review on the latest commit.`
              );
              return;
            }

            // Fail if Copilot requested changes (covers reviews with no inline comments)
            core.info(`Copilot review state: ${review.state}`);
            if (review.state === 'changes_requested' || review.state === 'CHANGES_REQUESTED') {
              core.setFailed('Copilot requested changes. Please address the feedback before merging.');
            }

            // Also check for inline comments from Copilot on this commit
            const { data: comments } = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const copilotComments = comments.filter(
              c => c.user.type === 'Bot'
                && c.user.login.toLowerCase().includes('copilot')
                && c.commit_id === headSha
            );

            if (copilotComments.length > 0) {
              core.setFailed(
                `Copilot found ${copilotComments.length} issue(s). Please address them before merging.`
              );
              for (const c of copilotComments) {
                core.error(`${c.path}: ${c.body.substring(0, 200)}`);
              }
            } else if (!core.exitCode) {
              core.info('Copilot review passed with no issues!');
            }
