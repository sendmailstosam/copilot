name: Copilot Review Gate

on:
  # Needed so branch protection always gets a status check
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

  # Runs immediately when a real review is submitted
  pull_request_review:
    types: [submitted]

jobs:
  copilot-review-gate:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read

    steps:
      - name: Enforce Copilot review gate
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const prNumber = context.payload.pull_request
              ? context.payload.pull_request.number
              : context.issue.number;

            core.info(`Starting Copilot review gate for PR #${prNumber}`);

            // COST-EFFICIENT POLLING CONFIG
            const MAX_ATTEMPTS = 6;      // total checks
            const WAIT_MS = 15000;      // 15 seconds between checks

            let copilotReviews = [];

            // Poll for Copilot review (short bounded wait)
            for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {

              core.info(`Polling attempt ${attempt}/${MAX_ATTEMPTS}`);

              const { data: reviews } = await github.rest.pulls.listReviews({
                owner,
                repo,
                pull_number: prNumber,
                per_page: 100
              });

              copilotReviews = reviews.filter(r =>
                r.user &&
                r.user.type === "Bot" &&
                r.user.login.toLowerCase().includes("copilot")
              );

              if (copilotReviews.length > 0) {
                core.info("Copilot review detected.");
                break;
              }

              if (attempt < MAX_ATTEMPTS) {
                core.info(`Copilot not ready yet. Waiting ${WAIT_MS/1000}s...`);
                await new Promise(r => setTimeout(r, WAIT_MS));
              }
            }

            // HARD BLOCK â€” no Copilot review found
            if (copilotReviews.length === 0) {
              core.setFailed(
                "Copilot review not detected yet. Waiting for Copilot review before merge."
              );
              return;
            }

            // Get latest PR info
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });

            const headSha = pr.head.sha;
            const latest = copilotReviews[copilotReviews.length - 1];

            core.info(`Latest Copilot review state: ${latest.state}`);
            core.info(`Review commit: ${latest.commit_id}`);

            // Block outdated review
            if (latest.commit_id !== headSha) {
              core.setFailed(
                "Copilot review is outdated. Please re-request Copilot review."
              );
              return;
            }

            // Block if changes requested
            if (
              latest.state === "CHANGES_REQUESTED" ||
              latest.state === "changes_requested"
            ) {
              core.setFailed(
                "Copilot requested changes. Address feedback before merging."
              );
              return;
            }

            // Check inline Copilot comments on latest commit
            const { data: comments } = await github.rest.pulls.listReviewComments({
              owner,
              repo,
              pull_number: prNumber,
              per_page: 100
            });

            const copilotComments = comments.filter(c =>
              c.user &&
              c.user.type === "Bot" &&
              c.user.login.toLowerCase().includes("copilot") &&
              c.commit_id === headSha
            );

            if (copilotComments.length > 0) {
              core.setFailed(
                `Copilot left ${copilotComments.length} comment(s). Resolve them before merging.`
              );

              for (const c of copilotComments) {
                core.error(`${c.path}: ${c.body.substring(0,200)}`);
              }
              return;
            }

            core.info("Copilot review gate passed!");
